function t(e){for(var i="",n=0;n<10;n++)i+="0123456789abcdefghjkmnpqrstvwxyz"[32*Math.random()|0];for(var r=i;e[r];)return t(e);return i}function e(t,e,i){for(var n in t.animate||(t.animate={}),i)t.animate[n]={duration:e,from:t[n],to:i[n]},t[n]=i[n]}function i(t,e,i){t._events||(t._events=[]),t._events.push({eventName:e,handler:i})}function n(t,e,i){t._events||(t._events=[]),t._events.filter((function(t){return t.eventName===e})).forEach((function(t){return t.handler(i)}))}var r=function(t){void 0===t&&(t={});var e=t.width;void 0===e&&(e=1920);var r=t.height;void 0===r&&(r=1080),this.width=e,this.height=r,this.cards=[],this.piles=[],this._uids={},this._cards={},this._moving=[],i(this,"movestart",(function(t){var e=t.card;t.i;n(e,"movestart")})),i(this,"move",(function(t){t.i;n(t.card,"move",t.diff)})),i(this,"moveend",(function(t){n(t.card,"moveend")}))};function a(t,e){var i=t.x,n=t.y,r=t.width,a=t.height,o=e.x,s=e.y,h=e.width,c=e.height;return i+r>=o&&i<=o+h&&n+a>=s&&n<=s+c}r.prototype.addDeck=function(t){this.addPile(t)},r.prototype.addPile=function(e){e.game=this,this.piles.push(e);for(var i=0;i<e.cards.length;i++){var n=e.cards[i];n.game=this,n.id=t(this._uids),this.cards.push(n),this._cards[n.id]=n}},r.prototype.pile=function(){!function(t){t.cards.sort((function(e,i){var n=t.getPos(e).z,r=t.getPos(i).z;return n>r?1:r>n?-1:0}))}(this)},r.prototype.getCard=function(t){return this._cards[t]},r.prototype.getPos=function(t,e){var i=t.x,n=t.y,r=t.z,a=t.pile,o=t.animate;void 0===o&&(o={});var s=e?function(t,e){var i=Date.now(),n={};for(var r in e){var a=e[r],o=a.duration,s=a.to,h=e[r],c=h.start,d=h.end,u=h.from;c||(c=e[r].start=Date.now(),d=e[r].end=c+o),i<d&&(n[r]=(d-Date.now())/o*(u-s))}return n}(0,o):{};return a?{x:i+(s.x||0)+a.x,y:n+(s.y||0)+a.y,z:r+(s.z||0)+a.z}:{x:i+(s.x||0),y:n+(s.y||0),z:r+(s.z||0)}};var o=function(t){void 0===t&&(t={});var e=t.x;void 0===e&&(e=0);var i=t.y;void 0===i&&(i=0);var n=t.z;void 0===n&&(n=0),this.x=e,this.y=i,this.z=n,this.cards=[]};o.prototype.intersecting=function(t,e){return a(t,e)},o.prototype.moveBack=function(t){var i=this.cards.indexOf(t);if(2===this.cards.length){var n=this.cards.find((function(e){return e!==t})),r=Math.abs(t.x-n.x),a=Math.abs(t.y-n.y);this.vertical=a>r}this.vertical?e(t,200,{x:0,y:30*i}):e(t,200,{x:15*i,y:0})},o.prototype.push=function(t){t.pile=this,t.x=t.x-this.x,t.y=t.y-this.y,this.cards.push(t),this.moveBack(t),t.z=this.cards.length},o.prototype.move=function(t){var e=this;this.cards.filter((function(e){return e!==t})).filter((function(i){return e.intersecting(t,i)})).length||this.remove(t)},o.prototype.remove=function(t){for(var i=!1,n=0;n<this.cards.length;n++){var r=this.cards[n];t===r?(t.pile=null,t.x+=this.x,t.y+=this.y,e(t,150,{z:0}),this.cards.splice(n--,1),i=!0):i&&(this.moveBack(r),r.z--)}1===this.cards.length&&this.remove(this.cards[0])};for(var s=new Array(54),h=0;h<s.length;h++)s[h]="img/front-"+h+".png";var c={width:102,height:144,back:"img/back.png",front:s};function d(t,e){var i=t.game.getPos(t),n=i.x,r=i.y,o=t.game.getPos(e),s=o.x,h=o.y;return a({x:n,y:r,width:e.width,height:e.height},{x:s,y:h,width:e.width,height:e.height})}var u=function(t){var n=this;void 0===t&&(t={});var r=t.i;void 0===r&&(r=0);var a=t.x;void 0===a&&(a=0);var s=t.y;void 0===s&&(s=0);var h=t.z;void 0===h&&(h=0);var d=t.graphics;void 0===d&&(d=c);var u=t.pile;this.i=r,this.x=a,this.y=s,this.z=h,this.graphics=d,this.pile=u,i(this,"move",(function(t){var i=n,r=i.game;if(i.x+=t.x,i.y+=t.y,i.pile)i.pile.move(i);else{var a=r.cards.filter((function(t){return!t.pile})).filter((function(t){return i!==t})).filter((function(t){return i.intersecting(t)})),o=r.piles.filter((function(t){return t.cards.find((function(t){return i.intersecting(t)}))})).map((function(t){return Object.assign({},t,{z:Math.max.apply(Math,t.cards.map((function(t){return t.z})))})})),s=Math.max.apply(Math,[-1].concat(a.concat(o).map((function(t){return t.z}))))+1;i.z!==s&&e(i,150,{z:s}),r.pile()}})),i(this,"moveend",(function(){var t=n,e=t.game;if(t.pile)t.pile.moveBack(t);else{var i=e.piles.find((function(e){return e.cards.find((function(e){return t.intersecting(e)}))}));if(i)return i.push(t),void e.pile();var r=e.cards.filter((function(e){return t!==e})).filter((function(t){return!t.pile})).find((function(e){return t.intersecting(e)}));if(r){var a=new o;a.x=r.x,a.y=r.y;var s=t.x-r.x,h=t.y-r.y;Math.abs(h)>Math.abs(s)&&(a.vertical=!0),a.push(r),a.push(t),e.addPile(a),e.pile()}}}))},v={width:{configurable:!0},height:{configurable:!0}};u.prototype.intersecting=function(t){return d(this,t)},v.width.get=function(){return this.graphics.width},v.height.get=function(){return this.graphics.height},Object.defineProperties(u.prototype,v);var f=function(t){function i(e){var i=this;void 0===e&&(e={});var n=e.graphics;void 0===n&&(n=c),t.call(this,Object.assign({},e,{graphics:n})),this.cards=n.front.map((function(t,e){return new u({graphics:n,pile:i,i:53-e,x:-e/4,y:-e/4,z:e})}))}return t&&(i.__proto__=t),i.prototype=Object.create(t&&t.prototype),i.prototype.constructor=i,i.prototype.shuffle=function(){!function(t){if(!t.length)return t;for(var e=t.length-1;e;e--){var i=Math.floor(Math.random()*(e+1)),n=t[e];t[e]=t[i],t[i]=n}}(this.cards),this.cards.forEach((function(t,e){t.x=-e/4,t.y=-e/4,t.z=e})),this.game.pile()},i.prototype.moveBack=function(t){var i=this.cards.indexOf(t);e(t,200,{x:-i/4,y:-i/4})},i.prototype.push=function(t){t.pile=this,t.x=t.x-this.x,t.y=t.y-this.y,e(t,200,{x:-this.cards.length/4,y:-this.cards.length/4}),this.cards.push(t),t.z=this.cards.length-1},i}(o),p=function(t){var e=t.game;this.game=e,this.container=document.createElement("div"),this.container.style.width=e.width+"px",this.container.style.height=e.height+"px",this.container.style.top="50%",this.container.style.left="50%",this.container.style.position="absolute",this.container.style.transform="translate(-50%, -50%)"};p.prototype.mountTo=function(t){t.appendChild(this.container)},p.prototype.render=function(){for(var t=this.game,e=this.container,i=t.cards,n=e.firstChild,r=0;r<i.length;r++){for(var a=i[r],o=a.graphics;n&&"IMG"!==n.tagName;){var s=n.nextSibling;n.parentNode.removeChild(n),n=s}n||((n=document.createElement("img")).draggable=!1,n.style.touchAction="none",n.style.position="absolute",e.appendChild(n));var h=n,c=a.width,d=a.height,u=a.side,v=o.back,f=o.front,p=t.getPos(a,!0),l=p.x,g=p.y;h.dataset.card=a.id;var m="back"===u?v:f[a.i],y="translate("+Math.round(l)+"px, "+Math.round(g)+"px)";m!==h.dataset.src&&(h.src=m,h.dataset.src=m),c!==h.dataset.width&&(h.width=c,h.style.marginLeft=-c/2+"px",h.dataset.width=c),d!==h.dataset.height&&(h.height=d,h.style.marginTop=-d/2+"px",h.dataset.height=d),y!==h.dataset.transform&&(h.style.transform=y,h.dataset.transform=y),n=n.nextSibling}for(;n;){var x=n.nextSibling;n.parentNode.removeChild(n),n=x}};var l=new r({container:document.querySelector("#cards"),width:1920,height:1080}),g=new p({game:l}),m=new f({x:960,y:540});l.addDeck(m),function(t,e){function i(e){var i=(e.target.dataset||{}).card;if(i){var r={x:(e.touches?e.touches[0]:e).pageX,y:(e.touches?e.touches[0]:e).pageY},a=t.getCard(i);if(a){n(t,"movestart",{card:a});var o=function(e){var i=(e.touches?e.touches[0]:e).pageX,o=(e.touches?e.touches[0]:e).pageY;n(t,"move",{card:a,diff:{x:i-r.x,y:o-r.y}}),r.x=i,r.y=o},s=function(e){window.removeEventListener("mousemove",o),window.removeEventListener("mouseup",s),window.removeEventListener("touchmove",o),window.removeEventListener("touchend",s),n(t,"moveend",{card:a})};window.addEventListener("mousemove",o),window.addEventListener("mouseup",s),window.addEventListener("touchmove",o),window.addEventListener("touchend",s)}}}e.container.addEventListener("mousedown",i),e.container.addEventListener("touchstart",i)}(l,g),m.shuffle(),g.mountTo(document.body),function t(){requestAnimationFrame(t),g.render()}();
